*================================================================*
* Program Name: HISTLD00
* Description: Position History DB2 Load Program
* Version: 1.0
* Date: 2024
*================================================================*
IDENTIFICATION DIVISION.
PROGRAM-ID. HISTLD00.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
SOURCE-COMPUTER. IBM-ZOS.
OBJECT-COMPUTER. IBM-ZOS.

INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT TRANSACTION-HISTORY
        ASSIGN TO TRANHIST
        ORGANIZATION IS INDEXED
        ACCESS MODE IS SEQUENTIAL
        RECORD KEY IS TH-KEY
        FILE STATUS IS WS-TH-STATUS.
        
    SELECT BATCH-CONTROL-FILE
        ASSIGN TO BCHCTL
        ORGANIZATION IS INDEXED
        ACCESS MODE IS DYNAMIC
        RECORD KEY IS BCT-KEY
        FILE STATUS IS WS-BCT-STATUS.

DATA DIVISION.
FILE SECTION.
FD  TRANSACTION-HISTORY.
    COPY HISTREC.

FD  BATCH-CONTROL-FILE.
    COPY BCHCTL.

WORKING-STORAGE SECTION.
    EXEC SQL BEGIN DECLARE SECTION END-EXEC.
    COPY DBTBLS.
    EXEC SQL END DECLARE SECTION END-EXEC.
    
    COPY SQLCA.
    COPY DBPROC.
    COPY ERRHAND.
    COPY BCHCON.
    
01  WS-FILE-STATUS.
    05  WS-TH-STATUS          PIC X(2).
    05  WS-BCT-STATUS         PIC X(2).
    
01  WS-COUNTERS.
    05  WS-RECORDS-READ       PIC S9(9) COMP VALUE 0.
    05  WS-RECORDS-WRITTEN    PIC S9(9) COMP VALUE 0.
    05  WS-ERROR-COUNT        PIC S9(9) COMP VALUE 0.
    05  WS-COMMIT-COUNT       PIC S9(4) COMP VALUE 0.
    
01  WS-COMMIT-THRESHOLD       PIC S9(4) COMP VALUE 1000.

01  WS-SWITCHES.
    05  WS-END-OF-FILE-SW     PIC X(1) VALUE 'N'.
        88  END-OF-FILE         VALUE 'Y'.
        88  MORE-RECORDS        VALUE 'N'.

01  WS-TRAN-CHANNEL-CODE      PIC X(4). *> Added for CHANNEL-CODE

PROCEDURE DIVISION.
0000-MAIN.
    PERFORM 1000-INITIALIZE
    
    PERFORM 2000-PROCESS
        UNTIL END-OF-FILE
        OR WS-ERROR-COUNT > 100
    
    PERFORM 3000-TERMINATE
    
    MOVE WS-ERROR-COUNT TO RETURN-CODE
    GOBACK
    .

1000-INITIALIZE.
    PERFORM 1100-OPEN-FILES
    PERFORM 1200-CONNECT-DB2
    PERFORM 1300-INIT-CHECKPOINTS
    .

2000-PROCESS.
    PERFORM 2100-READ-HISTORY
    
    IF MORE-RECORDS
        PERFORM 2200-LOAD-TO-DB2
        PERFORM 2300-CHECK-COMMIT
    END-IF
    .

2100-READ-HISTORY.
    READ TRANSACTION-HISTORY
        AT END
            SET END-OF-FILE TO TRUE
        NOT AT END
            ADD 1 TO WS-RECORDS-READ
            MOVE CHANNEL-CODE TO WS-TRAN-CHANNEL-CODE *> Added for CHANNEL-CODE
    END-READ
    .